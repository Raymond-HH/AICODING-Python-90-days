{% extends "base.html" %}

{% block title %}å­¦ä¹ ç¬”è®° - Python 90å¤©å­¦ä¹ ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="display-6 fw-bold text-primary mb-2">ğŸ“ å­¦ä¹ ç¬”è®°</h1>
        <p class="text-muted">è®°å½•æ‚¨çš„å­¦ä¹ å¿ƒå¾—å’Œé‡è¦çŸ¥è¯†ç‚¹</p>
    </div>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
            <i class="bi bi-plus-circle me-2"></i>æ·»åŠ ç¬”è®°
        </button>
    </div>
</div>

{% if notes %}
<div class="row">
    {% for day, note in notes.items() %}
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100 note-card" data-day="{{ day }}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="bi bi-calendar-day me-2"></i>ç¬¬{{ day }}å¤©
                </h6>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">{{ note.date }}</small>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item edit-note" href="#" data-day="{{ day }}" data-content="{{ note.content }}">
                                    <i class="bi bi-pencil me-2"></i>ç¼–è¾‘
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger delete-note" href="#" data-day="{{ day }}">
                                    <i class="bi bi-trash me-2"></i>åˆ é™¤
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <p class="card-text note-content">{{ note.content }}</p>
            </div>
            <div class="card-footer bg-white border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('course_day', day=day) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-book me-1"></i>æŸ¥çœ‹è¯¾ç¨‹
                    </a>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary edit-note" data-day="{{ day }}" data-content="{{ note.content }}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-note" data-day="{{ day }}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-journal-x text-muted" style="font-size: 4rem;"></i>
    <h4 class="text-muted mt-3">è¿˜æ²¡æœ‰å­¦ä¹ ç¬”è®°</h4>
    <p class="text-muted">å¼€å§‹å­¦ä¹ å¹¶è®°å½•æ‚¨çš„å¿ƒå¾—å§ï¼</p>
    <div class="d-flex gap-3 justify-content-center">
        <a href="{{ url_for('curriculum') }}" class="btn btn-primary">
            <i class="bi bi-book me-2"></i>å¼€å§‹å­¦ä¹ 
        </a>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
            <i class="bi bi-plus-circle me-2"></i>æ·»åŠ ç¬”è®°
        </button>
    </div>
</div>
{% endif %}

<!-- æ·»åŠ ç¬”è®°æ¨¡æ€æ¡† -->
<div class="modal fade" id="addNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>æ·»åŠ å­¦ä¹ ç¬”è®°
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addNoteForm">
                    <div class="mb-3">
                        <label for="noteDay" class="form-label">å­¦ä¹ å¤©æ•°</label>
                        <select class="form-select" id="noteDay" required>
                            <option value="">é€‰æ‹©å­¦ä¹ å¤©æ•°</option>
                            {% for i in range(1, 91) %}
                            <option value="{{ i }}">ç¬¬{{ i }}å¤©</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="noteContent" class="form-label">ç¬”è®°å†…å®¹</label>
                        <textarea class="form-control" id="noteContent" rows="6" placeholder="è®°å½•ä»Šå¤©çš„å­¦ä¹ å¿ƒå¾—ã€é‡ç‚¹çŸ¥è¯†æˆ–ç–‘é—®..." required></textarea>
                        <div class="form-text">æ”¯æŒæ¢è¡Œï¼Œå»ºè®®è®°å½•é‡ç‚¹æ¦‚å¿µã€ä»£ç ç¤ºä¾‹æˆ–å­¦ä¹ æ„Ÿæ‚Ÿ</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn">
                    <i class="bi bi-check-circle me-2"></i>ä¿å­˜ç¬”è®°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘ç¬”è®°æ¨¡æ€æ¡† -->
<div class="modal fade" id="editNoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>ç¼–è¾‘å­¦ä¹ ç¬”è®°
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editNoteForm">
                    <div class="mb-3">
                        <label for="editNoteDay" class="form-label">å­¦ä¹ å¤©æ•°</label>
                        <input type="text" class="form-control" id="editNoteDay" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editNoteContent" class="form-label">ç¬”è®°å†…å®¹</label>
                        <textarea class="form-control" id="editNoteContent" rows="6" required></textarea>
                        <div class="form-text">ä¿®æ”¹æ‚¨çš„å­¦ä¹ ç¬”è®°å†…å®¹</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="updateNoteBtn">
                    <i class="bi bi-check-circle me-2"></i>æ›´æ–°ç¬”è®°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>ç¡®è®¤åˆ é™¤
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤ç¬¬ <span id="deleteNoteDay"></span> å¤©çš„å­¦ä¹ ç¬”è®°å—ï¼Ÿ</p>
                <p class="text-muted small">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash me-2"></i>ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.note-card {
    transition: all 0.3s ease;
}

.note-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.note-content {
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.6;
}

.dropdown-toggle::after {
    display: none;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

.modal-lg {
    max-width: 800px;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
}

.note-card .card-footer {
    border-top: 1px solid rgba(0,0,0,0.125);
}

@media (max-width: 768px) {
    .btn-group {
        display: none;
    }
    
    .dropdown {
        display: block;
    }
}

@media (min-width: 769px) {
    .dropdown {
        display: none;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentEditDay = null;
    let currentDeleteDay = null;

    // æ·»åŠ ç¬”è®°
    document.getElementById('saveNoteBtn').addEventListener('click', function() {
        const day = document.getElementById('noteDay').value;
        const content = document.getElementById('noteContent').value.trim();

        if (!day || !content) {
            alert('è¯·å¡«å†™å®Œæ•´çš„ç¬”è®°ä¿¡æ¯');
            return;
        }

        fetch('/api/add_note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                day: day,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('ä¿å­˜å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    });

    // ç¼–è¾‘ç¬”è®°
    document.querySelectorAll('.edit-note').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            currentEditDay = this.dataset.day;
            const content = this.dataset.content;

            document.getElementById('editNoteDay').value = `ç¬¬${currentEditDay}å¤©`;
            document.getElementById('editNoteContent').value = content;

            const editModal = new bootstrap.Modal(document.getElementById('editNoteModal'));
            editModal.show();
        });
    });

    // æ›´æ–°ç¬”è®°
    document.getElementById('updateNoteBtn').addEventListener('click', function() {
        const content = document.getElementById('editNoteContent').value.trim();

        if (!content) {
            alert('ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º');
            return;
        }

        fetch('/api/update_note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                day: currentEditDay,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('æ›´æ–°å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    });

    // åˆ é™¤ç¬”è®°
    document.querySelectorAll('.delete-note').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            currentDeleteDay = this.dataset.day;
            document.getElementById('deleteNoteDay').textContent = currentDeleteDay;

            const deleteModal = new bootstrap.Modal(document.getElementById('deleteNoteModal'));
            deleteModal.show();
        });
    });

    // ç¡®è®¤åˆ é™¤
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        fetch('/api/delete_note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                day: currentDeleteDay
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    });

    // æ¸…ç©ºè¡¨å•å½“æ¨¡æ€æ¡†å…³é—­æ—¶
    document.getElementById('addNoteModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('addNoteForm').reset();
    });
});
</script>
{% endblock %} 